name: Sync to Org Repo

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo A
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify token can access org repo
        env:
          ORG_REPO: EpitechPGE3-2025/G-AIA-500-PAR-5-1-gomoku-3
          TOKEN: ${{ secrets.UPSTREAM_TOKEN }}
        run: |
          echo "Testing token access to ${ORG_REPO}..."
          RESPONSE=$(curl -s -H "Authorization: token ${TOKEN}" \
            "https://api.github.com/repos/${ORG_REPO}")
          
          HTTP_CODE=$(echo "$RESPONSE" | jq -r '.message // "200"')
          PERMISSIONS=$(echo "$RESPONSE" | jq -r '.permissions // {}')
          
          echo "Repository permissions:"
          echo "$PERMISSIONS" | jq '.'
          
          CAN_PUSH=$(echo "$PERMISSIONS" | jq -r '.push // false')
          
          if [ "$CAN_PUSH" != "true" ]; then
            echo "ERROR: Token does not have push permission to this repository"
            echo "You need to be a collaborator with write access"
            exit 1
          fi
          echo "âœ“ Token has push access to repository"

      - name: Push to repo B
        env:
          ORG_REPO: EpitechPGE3-2025/G-AIA-500-PAR-5-1-gomoku-3
          TOKEN: ${{ secrets.UPSTREAM_TOKEN }}
          GITHUB_USER: ${{ github.actor }}
        run: |
          git config --global credential.helper store
          echo "https://${GITHUB_USER}:${TOKEN}@github.com" > ~/.git-credentials
          git remote add org https://github.com/${ORG_REPO}.git
          git push org main:docs/add-project-documentation --force
          rm ~/.git-credentials
